<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Botar o Shape Project</title>
    <style>
        /* CSS (Styling) */
        :root {
            --primary-color: #007BFF;
            --secondary-color: #F8F9FA;
            --text-color: #333;
            --light-text-color: #777;
            --border-color: #E9ECEF;
            --accent-color: #28A745;
            --rest-color: #FFC107;
            --background-color: #FFFFFF;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            background-color: var(--secondary-color);
            color: var(--text-color);
            overscroll-behavior: none;
        }

        .app-container {
            max-width: 600px;
            margin: 0 auto;
            background-color: var(--background-color);
            min-height: 100vh;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
        }

        .app-header {
            background-color: var(--primary-color);
            color: var(--background-color);
            padding: 1rem 1.5rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .app-header h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        main {
            padding: 1rem;
        }

        section {
            display: none; /* Hide all sections by default */
        }

        section.active {
            display: block; /* Show active section */
        }
        
        .day-card {
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .day-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }
        
        .day-card.today {
            border-left: 5px solid var(--primary-color);
            font-weight: bold;
        }

        .day-info h3 {
            margin: 0 0 0.25rem 0;
            font-size: 1.1rem;
        }

        .day-info p {
            margin: 0;
            font-size: 0.9rem;
            color: var(--light-text-color);
        }
        
        .arrow {
            font-size: 1.5rem;
            color: var(--border-color);
        }

        .session-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .back-button {
            background: none;
            border: none;
            font-size: 1.75rem;
            cursor: pointer;
            color: var(--primary-color);
            margin-right: 1rem;
            padding: 0 0.5rem;
        }
        
        .session-title h2 {
            margin: 0;
            font-size: 1.5rem;
        }
        .session-title p {
            margin: 0;
            color: var(--light-text-color);
        }

        .session-details p, .session-notes p {
            background-color: var(--secondary-color);
            padding: 1rem;
            border-radius: 8px;
            line-height: 1.5;
        }

        .superset-card, .circuit-card {
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1.5rem;
            padding: 1.25rem;
        }

        .circuit-card ul {
            list-style: none;
            padding: 0;
        }
        .circuit-card li {
            background-color: var(--secondary-color);
            padding: 0.75rem 1rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }

        .superset-header h4 {
            margin: 0 0 1rem 0;
            font-size: 1.2rem;
            color: var(--primary-color);
        }
        
        .superset-header-info {
           display: flex;
           justify-content: space-between;
           color: var(--light-text-color);
           font-size: 0.9rem;
           margin-bottom: 1rem;
           padding-bottom: 0.75rem;
           border-bottom: 1px solid var(--border-color);
        }
        
        .exercise {
            margin-bottom: 1rem;
        }
        
        .exercise:last-child {
            margin-bottom: 0;
        }
        
        .exercise-name {
            font-weight: bold;
            margin: 0 0 0.25rem 0;
        }
        
        .exercise-reps {
            color: var(--light-text-color);
            margin: 0 0 0.5rem 0;
        }

        .exercise-description {
            font-size: 0.85rem;
            color: var(--light-text-color);
            margin: 0;
            font-style: italic;
        }
        
        .start-workout-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            width: 100%;
            padding: 1rem;
            font-size: 1.1rem;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 1rem;
            transition: background-color 0.2s;
        }
        
        .start-workout-btn:hover {
            background-color: #218838;
        }
        
        .workout-view {
            text-align: center;
        }
        
        .workout-progress {
            font-size: 1rem;
            color: var(--light-text-color);
            margin-bottom: 1rem;
        }
        
        .workout-exercise-name {
            font-size: 2rem;
            font-weight: bold;
            margin: 0 0 0.5rem 0;
        }

        .show-media-btn {
            background: none;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        
        .timer-visual-container {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 1rem auto;
        }

        .countdown-svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .countdown-bg, .countdown-progress {
            fill: none;
            stroke-width: 10;
        }

        .countdown-bg {
            stroke: var(--border-color);
        }

        .countdown-progress {
            stroke: var(--rest-color);
            stroke-linecap: round;
            transition: stroke-dashoffset 1s linear;
        }

        .timer-display {
            font-size: 6rem;
            font-weight: bold;
            margin: 1rem auto;
            color: var(--primary-color);
        }
        
        .timer-display.in-visual {
            position: absolute;
            top: 39%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            font-weight: bold;
            color: var(--text-color);
        }

        .timer-display.resting {
            color: var(--rest-color);
        }

        .countdown-progress.emom {
             stroke: var(--accent-color);
        }
        .timer-display.emom {
            color: var(--accent-color);
        }


        .workout-reps {
            font-size: 2.5rem;
            margin-bottom: 2rem;
        }
        
        .workout-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 2rem;
            gap: 1rem;
        }

        .workout-btn {
            padding: 1rem 2rem;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid var(--primary-color);
            background-color: var(--background-color);
            color: var(--primary-color);
            min-width: 100px;
        }
        
        .main-action-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 1.25rem 2.5rem;
            font-size: 1.2rem;
            transform: scale(1.1);
        }
        
        .finish-workout-btn {
             background-color: #6c757d;
             color: white;
             border: none;
             width: 100%;
             padding: 1rem;
             font-size: 1.1rem;
             border-radius: 8px;
             cursor: pointer;
             margin-top: 2rem;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            position: relative;
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
        }
        
        .modal-content img {
            width: 100%;
            height: auto;
            border-radius: 4px;
        }

        .modal-close-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            color: white;
            background-color: var(--primary-color);
            font-size: 28px;
            font-weight: bold;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            border: 2px solid white;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            line-height: 1;
        }
    </style>
</head>
<body>

    <div class="app-container">
        <header class="app-header">
            <h1>Botar o Shape Project</h1>
        </header>

        <main>
            <section id="weekly-view" class="active"></section>
            <section id="session-view"></section>
            <section id="workout-view"></section>
        </main>
        
        <!-- Media Modal Structure -->
        <div id="media-modal" class="modal-overlay">
            <div class="modal-content">
                <button id="modal-close-btn" class="modal-close-btn">&times;</button>
                <img id="modal-image" src="" alt="Exercise Example"
                     onerror="this.onerror=null;this.src='https://placehold.co/400x400/eee/ccc?text=Image+Not+Found';">
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        const trainingData = {
            "program": [
                { "day": "Monday", "session": "EMS", "type": "EMS", "time_minutes": 20, "notes": "Sessão de eletroestimulação guiada em estúdio.", "exercises": [] },
                { "day": "Tuesday", "session": "Treino A – Push & Core", "type": "Strength Supersets", "time_minutes": 45, "supersets": [
                    { "name": "Superset A", "sets": 3, "rest_seconds": 60, "exercises": [ { "name": "Dumbbell Bench Press", "reps": "8-12", "description": "Supino com halteres focado em peito e ombros.", "media": "https://images.squarespace-cdn.com/content/v1/54f9e84de4b0d13f30bba4cb/1526590877144-BYR9X8ZX5FROTGOZ2VHL/DSC_6330.mov.gif" }, { "name": "Plank Shoulder Tap", "reps": 12, "description": "Prancha alta tocando os ombros; core anti-rotação.", "media": "https://d24bnpykhxwj9p.cloudfront.net/s3file/s3fs-public/users1/2017-11/Tue/shoulder%20tap.gif" } ] },
                    { "name": "Superset B", "sets": 3, "rest_seconds": 60, "exercises": [ { "name": "Overhead Press", "reps": "8-12", "description": "Desenvolvimento militar em pé.", "media": "https://149874912.v2.pressablecdn.com/wp-content/uploads/2020/12/Overhead-press-exercise.gif" }, { "name": "Hollow Hold", "reps": "30s", "description": "Isometria em hollow para core.", "media": "https://experiencelife.lifetime.life/wp-content/uploads/2021/03/EL_BID_HollowHold.gif" } ] },
                    { "name": "Superset C", "sets": 3, "rest_seconds": 60, "exercises": [ { "name": "Parallel Bar Dips (or Bench Dips)", "reps": "8-12", "description": "Tríceps e peito.", "media": "https://i0.wp.com/www.strengthlog.com/wp-content/uploads/2023/03/bench-dips.gif?resize=600%2C600&ssl=1" }, { "name": "Body-Saw PLank", "reps": "45s", "description": "Prancha com deslize.", "media": "https://media.self.com/photos/5c93d4df23ccbc4420bd90a8/master/w_320%2Cc_limit/body-saw-with-gliders-Amanda_066.gif" } ] }
                ]},
                { "day": "Wednesday", "session": "Treino B – Lower & Pull", "type": "Strength Supersets", "time_minutes": 45, "supersets": [
                    { "name": "Superset A", "sets": 3, "rest_seconds": 60, "exercises": [ { "name": "Barbell Back Squat", "reps": "8-10", "description": "Agachamento livre.", "media": "https://149874912.v2.pressablecdn.com/wp-content/uploads/2021/11/squat.gif" }, { "name": "Face Pull (Band/Cable)", "reps": 15, "description": "Estabilidade escapular.", "media": "https://149874912.v2.pressablecdn.com/wp-content/uploads/2020/05/face-pull.gif" } ] },
                    { "name": "Superset B", "sets": 3, "rest_seconds": 60, "exercises": [ { "name": "Romanian Deadlift", "reps": "8-10", "description": "Posterior de coxa e glúteos.", "media": "https://149874912.v2.pressablecdn.com/wp-content/uploads/2022/01/Romanian-deadlift.gif" }, { "name": "Bird-Dog", "reps": "12/lado", "description": "Core anti-rotação.", "media": "https://media.post.rvohealth.io/wp-content/uploads/sites/2/2021/02/NarrowVibrantHawk-size_restricted.gif" } ] },
                    { "name": "Superset C", "sets": 3, "rest_seconds": 60, "exercises": [ { "name": "Bent-Over Row", "reps": "8-12", "description": "Dorsais e bíceps.", "media": "https://i0.wp.com/www.strengthlog.com/wp-content/uploads/2022/03/Barbell-Row.gif" }, { "name": "Standing Calf Raise", "reps": 15, "description": "Panturrilhas.", "media": "https://cdn.jefit.com/assets/img/exercises/gifs/142.gif" } ] }
                ]},
                { "day": "Thursday", "session": "EMS", "type": "EMS", "time_minutes": 20, "notes": "Sessão de eletroestimulação guiada.", "exercises": [] },
                { "day": "Friday", "session": "Active Recovery", "type": "Recovery", "time_minutes": 30, "notes": "Alongamentos, liberação miofascial ou caminhada leve.", "exercises": [] },
                { "day": "Saturday", "session": "Treino C – Full-Body Metabólico", "type": "EMOM Circuit", "time_minutes": 35, "circuit": { "format": "EMOM", "rounds": 5, "duration_per_exercise_seconds": 60, "exercises": [ 
                    {"name": "Kettlebell Swing", "reps": 15, "media": "https://media.tenor.com/gJGN16fm_doAAAAC/kettlebell-swing.gif"}, 
                    {"name": "Push-Up", "reps": "Max", "media": "https://www.inspireusafoundation.org/wp-content/uploads/2022/08/push-up.gif"}, 
                    {"name": "Goblet Squat", "reps": 15, "media": "https://www.inspireusafoundation.org/wp-content/uploads/2022/10/goblet-squat.gif"}, 
                    {"name": "TRX Row", "reps": "Max", "media": "https://i.pinimg.com/originals/a1/b0/c6/a1b0c6606519123e49176885348874fb.gif"}, 
                    {"name": "Jump Rope", "duration": "45s", "media": "https://media.self.com/photos/59235d64a8524634b47c0b78/master/w_320%2Cc_limit/jump-rope.gif"}, 
                    {"name": "Rest", "duration": "60s"} 
                ] } },
                { "day": "Sunday", "session": "Rest", "type": "Rest", "notes": "Recuperação total. Good job this week!", "exercises": [] }
            ]
        };

        // --- APP STATE ---
        const state = {
            currentView: 'weekly-view',
            selectedDay: null,
            workout: {
                // Shared
                active: false,
                type: null, // 'superset' or 'emom'
                
                // Superset state
                isResting: false,
                supersetIndex: 0,
                exerciseIndex: 0,
                set: 1,

                // EMOM state
                isPaused: false,
                currentRound: 0,
                currentMinute: 0,
                emomTimeLeft: 0
            },
            timer: {
                interval: null,
            }
        };

        // --- DOM ELEMENT CACHE ---
        const views = {
            weekly: document.getElementById('weekly-view'),
            session: document.getElementById('session-view'),
            workout: document.getElementById('workout-view')
        };
        const modal = {
            overlay: document.getElementById('media-modal'),
            image: document.getElementById('modal-image'),
            closeBtn: document.getElementById('modal-close-btn')
        };
        
        // --- RENDER FUNCTIONS ---
        function renderWeeklyView() {
            const today = new Date().toLocaleString('en-US', { weekday: 'long' });
            let html = '';
            trainingData.program.forEach(day => {
                const isToday = day.day === today;
                html += `
                    <div class="day-card ${isToday ? 'today' : ''}" data-day="${day.day}">
                        <div class="day-info">
                            <h3>${day.day}</h3>
                            <p>${day.session}</p>
                        </div>
                        <span class="arrow">&rsaquo;</span>
                    </div>`;
            });
            views.weekly.innerHTML = html;

            document.querySelectorAll('.day-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    const dayName = e.currentTarget.dataset.day;
                    const dayData = trainingData.program.find(d => d.day === dayName);
                    if (dayData) {
                        state.selectedDay = dayData;
                        navigateTo('session-view');
                    }
                });
            });
        }

        function renderSessionView() {
            const day = state.selectedDay;
            let html = `
                <div class="session-header">
                    <button class="back-button" id="back-to-week-btn">&lsaquo;</button>
                    <div class="session-title"><h2>${day.day}</h2><p>${day.session}</p></div>
                </div>`;
            
            if (day.type === "Strength Supersets" && day.supersets?.length) {
                day.supersets.forEach(superset => {
                    html += `
                        <div class="superset-card">
                            <div class="superset-header">
                                <h4>${superset.name}</h4>
                                <div class="superset-header-info">
                                    <span>${superset.sets} SETS</span>
                                    <span>${superset.rest_seconds}s REST</span>
                                </div>
                            </div>
                            ${(superset.exercises || []).map(ex => `
                                <div class="exercise">
                                    <p class="exercise-name">${ex.name}</p>
                                    <p class="exercise-reps">Reps: ${ex.reps}</p>
                                    <p class="exercise-description">${ex.description}</p>
                                </div>`).join('')}
                        </div>`;
                });
                html += `<button class="start-workout-btn" id="start-workout-btn">Start Workout</button>`;
            } 
            else if (day.type === "EMOM Circuit" && day.circuit) {
                const circuit = day.circuit;
                html += `
                    <div class="circuit-card">
                         <div class="superset-header">
                            <h4>${circuit.format} Details</h4>
                            <div class="superset-header-info">
                                <span>${circuit.rounds} ROUNDS</span>
                                <span>${circuit.duration_per_exercise_seconds}s PER EXERCISE</span>
                            </div>
                        </div>
                        <ul>
                            ${(circuit.exercises || []).map((ex, index) => `<li>Minute ${index + 1}: <strong>${ex.name}</strong></li>`).join('')}
                        </ul>
                    </div>
                `;
                html += `<button class="start-workout-btn" id="start-workout-btn">Start Workout</button>`;
            }
            else if (day.notes) {
                 html += `<div class="session-details"><p>${day.notes}</p></div>`;
            }
            else {
                 html += `<div class="session-notes"><p>No workout details available.</p></div>`;
            }

            views.session.innerHTML = html;
            
            document.getElementById('back-to-week-btn').addEventListener('click', () => navigateTo('weekly-view'));
            const startBtn = document.getElementById('start-workout-btn');
            if (startBtn) {
                startBtn.addEventListener('click', startWorkout);
            }
        }
        
        // --- WORKOUT VIEW ROUTER ---
        function renderWorkoutView() {
            // No longer clear interval here, let the specific workout logic handle it
            // clearInterval(state.timer.interval);
            switch (state.workout.type) {
                case 'superset':
                    renderSupersetWorkout();
                    break;
                case 'emom':
                    renderEmomWorkout();
                    break;
                default:
                    // If workout is active but type is unknown, end it.
                    endWorkout();
            }
        }
        
        // --- SUPERSET WORKOUT ---
        function renderSupersetWorkout() {
            clearInterval(state.timer.interval);
            const day = state.selectedDay;

            if (state.workout.isResting) {
                const superset = day.supersets?.[state.workout.supersetIndex];
                if (superset) {
                    renderRestScreen(superset.rest_seconds);
                } else {
                    endWorkout();
                }
                return;
            }

            const superset = day.supersets?.[state.workout.supersetIndex];
            const exercise = superset?.exercises?.[state.workout.exerciseIndex];
            
            if (!exercise) {
                renderCompletionScreen();
                return;
            }

            const progressText = `Set ${state.workout.set}/${superset.sets} | Superset ${state.workout.supersetIndex + 1}/${day.supersets.length}`;
            const isTimed = typeof exercise.reps === 'string' && exercise.reps.endsWith('s');
            
            let html = `
                <div class="workout-view">
                    <div class="session-header">
                        <button class="back-button" id="back-to-session-btn">&lsaquo;</button>
                        <div class="session-title"><h2>${day.session}</h2></div>
                    </div>
                    <p class="workout-progress">${progressText}</p>
                    <h3 class="workout-exercise-name">${exercise.name}</h3>
                    ${exercise.media ? `<button class="show-media-btn" id="show-media-btn">Show Example</button>` : ''}
                    `;

            if (isTimed) {
                const duration = parseInt(exercise.reps);
                html += `<div class="timer-display">${duration}</div>
                    <div class="workout-controls">
                        <button class="workout-btn main-action-btn" id="timed-action-btn">Start</button>
                    </div>`;
            } else {
                html += `<div class="workout-reps">${exercise.reps}</div>
                    <div class="workout-controls">
                        <button class="workout-btn" id="prev-exercise-btn">Prev</button>
                        <button class="workout-btn main-action-btn" id="next-exercise-btn">Done</button>
                    </div>`;
            }
            html += `<button class="finish-workout-btn" id="end-workout-btn">End Workout</button></div>`;
            views.workout.innerHTML = html;

            document.getElementById('back-to-session-btn').addEventListener('click', endWorkout);
            document.getElementById('end-workout-btn').addEventListener('click', endWorkout);
            
            const showMediaBtn = document.getElementById('show-media-btn');
            if(showMediaBtn) showMediaBtn.addEventListener('click', () => openMediaModal(exercise.media));

            const prevBtn = document.getElementById('prev-exercise-btn');
            if (prevBtn) prevBtn.addEventListener('click', prevExercise);

            const nextBtn = document.getElementById('next-exercise-btn');
            if (nextBtn) nextBtn.addEventListener('click', nextExercise);

            const timedBtn = document.getElementById('timed-action-btn');
            if (timedBtn) {
                 const duration = parseInt(exercise.reps);
                 timedBtn.addEventListener('click', () => startExerciseTimer(duration));
            }
        }

        // --- EMOM WORKOUT ---
        function renderEmomWorkout() {
            const day = state.selectedDay;
            const circuit = day.circuit;
            const totalMinutes = circuit.exercises.length * circuit.rounds;
            const currentOverallMinute = state.workout.currentRound * circuit.exercises.length + state.workout.currentMinute;
            
            if (currentOverallMinute >= totalMinutes) {
                renderCompletionScreen();
                return;
            }

            const exercise = circuit.exercises[state.workout.currentMinute];

            let html = `
                <div class="workout-view">
                    <div class="session-header">
                        <button class="back-button" id="back-to-session-btn">&lsaquo;</button>
                        <div class="session-title"><h2>${circuit.format}</h2></div>
                    </div>
                    <p class="workout-progress">Round ${state.workout.currentRound + 1} of ${circuit.rounds} | Minute ${currentOverallMinute + 1} of ${totalMinutes}</p>
                    <h3 class="workout-exercise-name">${exercise.name}</h3>
                    ${exercise.media ? `<button class="show-media-btn" id="show-media-btn">Show Example</button>` : ''}
                    
                    <div class="timer-visual-container">
                        <svg class="countdown-svg">
                            <circle class="countdown-bg" cx="100" cy="100" r="90"></circle>
                            <circle class="countdown-progress emom" id="countdown-progress-circle" cx="100" cy="100" r="90"></circle>
                        </svg>
                        <div class="timer-display in-visual emom" id="emom-timer-display">${state.workout.emomTimeLeft}</div>
                    </div>

                    <div class="workout-controls">
                        <button class="workout-btn main-action-btn" id="emom-control-btn">${state.workout.isPaused ? "Resume" : "Pause"}</button>
                    </div>
                    <button class="finish-workout-btn" id="end-workout-btn">End Workout</button>
                </div>`;

            views.workout.innerHTML = html;
            
            updateEmomTimerVisual(state.workout.emomTimeLeft, circuit.duration_per_exercise_seconds);
            
            document.getElementById('back-to-session-btn').addEventListener('click', endWorkout);
            document.getElementById('end-workout-btn').addEventListener('click', endWorkout);
            document.getElementById('emom-control-btn').addEventListener('click', toggleEmomPause);
            
            const showMediaBtn = document.getElementById('show-media-btn');
            if(showMediaBtn) showMediaBtn.addEventListener('click', () => openMediaModal(exercise.media));
        }


        function renderRestScreen(duration) {
            clearInterval(state.timer.interval);
            let html = `
                <div class="workout-view">
                    <p class="workout-progress">Next set coming up...</p>
                    <h3 class="workout-exercise-name">REST</h3>
                    <div class="timer-visual-container">
                        <svg class="countdown-svg">
                            <circle class="countdown-bg" cx="100" cy="100" r="90"></circle>
                            <circle class="countdown-progress" id="countdown-progress-circle" cx="100" cy="100" r="90"></circle>
                        </svg>
                        <div class="timer-display in-visual resting" id="rest-timer-display">${duration}</div>
                    </div>
                    <div class="workout-controls">
                        <button class="workout-btn main-action-btn" id="skip-rest-btn">Skip Rest</button>
                    </div>
                    <button class="finish-workout-btn" id="end-workout-btn-rest">End Workout</button>
                </div>`;
            views.workout.innerHTML = html;

            document.getElementById('skip-rest-btn').addEventListener('click', skipRest);
            document.getElementById('end-workout-btn-rest').addEventListener('click', endWorkout);
            startRestTimer(duration);
        }
        
        function renderCompletionScreen() {
             clearInterval(state.timer.interval);
             let html = `
                <div class="workout-view">
                    <h3 class="workout-exercise-name">Workout Complete!</h3>
                    <p class="workout-progress">Great job!</p>
                       <div class="workout-controls">
                            <button class="workout-btn main-action-btn" id="back-to-home-btn">Done</button>
                       </div>
                </div>`;
            views.workout.innerHTML = html;
            document.getElementById('back-to-home-btn').addEventListener('click', () => {
                resetWorkoutState();
                navigateTo('weekly-view');
            });
        }

        // --- NAVIGATION ---
        function navigateTo(viewId) {
            state.currentView = viewId;
            // Only clear timer if not navigating to the workout view itself
            if (viewId !== 'workout-view') {
                 clearInterval(state.timer.interval);
            }
            
            for (const key in views) {
                views[key].classList.toggle('active', key === viewId.replace('-view', ''));
            }

            switch(viewId) {
                case 'weekly-view': renderWeeklyView(); break;
                case 'session-view': renderSessionView(); break;
                case 'workout-view': renderWorkoutView(); break;
            }
            window.scrollTo(0, 0);
        }

        // --- TIMER LOGIC ---
        function startExerciseTimer(duration) {
            clearInterval(state.timer.interval);
            let timeLeft = duration;
            const timerDisplay = views.workout.querySelector('.timer-display');
            const actionButton = views.workout.querySelector('#timed-action-btn');
            actionButton.textContent = 'Skip';
            actionButton.onclick = nextExercise;

            state.timer.interval = setInterval(() => {
                timeLeft--;
                if(timerDisplay) timerDisplay.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(state.timer.interval);
                    nextExercise();
                }
            }, 1000);
        }

        function startRestTimer(duration) {
            clearInterval(state.timer.interval);
            let timeLeft = duration;
            
            updateRestTimerVisual(timeLeft, duration); // Initial paint

            state.timer.interval = setInterval(() => {
                const timerDisplay = document.getElementById('rest-timer-display');
                if (!timerDisplay) {
                    clearInterval(state.timer.interval);
                    return;
                };

                updateRestTimerVisual(timeLeft, duration);
                timerDisplay.textContent = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(state.timer.interval);
                    skipRest();
                }
                timeLeft--;
            }, 1000);
        }
        
        function startEmomTimer() {
            clearInterval(state.timer.interval);
            const circuit = state.selectedDay.circuit;

            // Initial paint for the new minute
            updateEmomTimerVisual(state.workout.emomTimeLeft, circuit.duration_per_exercise_seconds);
            const timerDisplay = document.getElementById('emom-timer-display');
            if (timerDisplay) timerDisplay.textContent = state.workout.emomTimeLeft;


            state.timer.interval = setInterval(() => {
                if(state.workout.isPaused) return;
                
                if (state.workout.emomTimeLeft <= 0) {
                    nextEmomMinute();
                    return;
                }

                updateEmomTimerVisual(state.workout.emomTimeLeft, circuit.duration_per_exercise_seconds);
                const currentTimerDisplay = document.getElementById('emom-timer-display');
                if (currentTimerDisplay) currentTimerDisplay.textContent = state.workout.emomTimeLeft;
                
                state.workout.emomTimeLeft--;

            }, 1000);
        }
        
        function updateRestTimerVisual(timeLeft, duration) {
            const progressCircle = document.getElementById('countdown-progress-circle');
            if (!progressCircle) return;
            const radius = progressCircle.r.baseVal.value;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (timeLeft / duration) * circumference;

            progressCircle.style.strokeDasharray = circumference;
            progressCircle.style.strokeDashoffset = offset;
        }

        function updateEmomTimerVisual(timeLeft, duration) {
            const progressCircle = document.getElementById('countdown-progress-circle');
            if (!progressCircle) return;
            const radius = progressCircle.r.baseVal.value;
            const circumference = 2 * Math.PI * radius;
            // Use the same robust formula as the rest timer
            const offset = circumference - (timeLeft / duration) * circumference;

            progressCircle.style.strokeDasharray = circumference;
            progressCircle.style.strokeDashoffset = offset;
        }


        // --- WORKOUT LOGIC ---
        function resetWorkoutState() {
             Object.assign(state.workout, {
                active: false, type: null, isResting: false,
                supersetIndex: 0, exerciseIndex: 0, set: 1,
                isPaused: false, currentRound: 0, currentMinute: 0, emomTimeLeft: 0
            });
            clearInterval(state.timer.interval);
        }


        function startWorkout() {
            const day = state.selectedDay;
            resetWorkoutState();
            state.workout.active = true;

            if (day.type === 'Strength Supersets') {
                state.workout.type = 'superset';
                navigateTo('workout-view');
            } else if (day.type === 'EMOM Circuit') {
                state.workout.type = 'emom';
                state.workout.emomTimeLeft = day.circuit.duration_per_exercise_seconds;
                navigateTo('workout-view');
                startEmomTimer();
            }
        }

        function endWorkout() {
            resetWorkoutState();
            navigateTo('session-view');
        }

        function skipRest() {
            // No need to clear interval here, it's handled by the calling function
            state.workout.isResting = false;
            renderSupersetWorkout();
        }

        function nextExercise() {
            // No need to clear interval here, it's handled by the calling function
            const day = state.selectedDay;
            if (!day || day.type !== 'Strength Supersets') return;
            
            const superset = day.supersets[state.workout.supersetIndex];
            const isLastExerciseInSet = state.workout.exerciseIndex >= superset.exercises.length - 1;

            if (isLastExerciseInSet) {
                state.workout.exerciseIndex = 0;
                state.workout.set++;
                
                if (state.workout.set > superset.sets) {
                    state.workout.set = 1;
                    state.workout.supersetIndex++;
                    
                    if (state.workout.supersetIndex >= day.supersets.length) {
                        renderCompletionScreen();
                        return;
                    }
                }
                state.workout.isResting = true;
            } else {
                state.workout.exerciseIndex++;
            }
            renderSupersetWorkout();
        }

        function prevExercise() {
            clearInterval(state.timer.interval);
            state.workout.isResting = false;
            const day = state.selectedDay;
            if (!day) return;

            state.workout.exerciseIndex--;
            if (state.workout.exerciseIndex < 0) {
                const currentSupersetIndex = state.workout.supersetIndex;
                const currentSet = state.workout.set;

                if (currentSet > 1) {
                    state.workout.set--;
                } else if (currentSupersetIndex > 0) {
                    state.workout.supersetIndex--;
                    const prevSuperset = day.supersets[state.workout.supersetIndex];
                    state.workout.set = prevSuperset.sets;
                }
                const prevSuperset = day.supersets[state.workout.supersetIndex];
                state.workout.exerciseIndex = prevSuperset.exercises.length - 1;
            }
            renderSupersetWorkout();
        }

        function nextEmomMinute() {
            clearInterval(state.timer.interval);
            const circuit = state.selectedDay.circuit;
            state.workout.currentMinute++;

            if (state.workout.currentMinute >= circuit.exercises.length) {
                state.workout.currentMinute = 0;
                state.workout.currentRound++;
            }
            
            const totalMinutes = circuit.exercises.length * circuit.rounds;
            const currentOverallMinute = state.workout.currentRound * circuit.exercises.length + state.workout.currentMinute;

            if (currentOverallMinute >= totalMinutes) {
                renderCompletionScreen();
            } else {
                state.workout.emomTimeLeft = circuit.duration_per_exercise_seconds;
                renderEmomWorkout();
                startEmomTimer();
            }
        }
        
        function toggleEmomPause() {
            state.workout.isPaused = !state.workout.isPaused;
            const btn = document.getElementById('emom-control-btn');
            if (btn) btn.textContent = state.workout.isPaused ? "Resume" : "Pause";
        }

        // --- MODAL LOGIC ---
        function openMediaModal(url) {
            modal.image.src = url;
            modal.overlay.style.display = 'flex';
        }
        
        function closeMediaModal() {
            modal.overlay.style.display = 'none';
            modal.image.src = ''; // Stop gif from loading in the background
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            navigateTo('weekly-view');
            modal.closeBtn.addEventListener('click', closeMediaModal);
            modal.overlay.addEventListener('click', (e) => {
                if (e.target === modal.overlay) {
                    closeMediaModal();
                }
            });
        });
    </script>
</body>
</html>
